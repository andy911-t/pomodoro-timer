<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Focus App</title>
    <meta name="apple-mobile-web-app-title" content="Focus App">
    <meta name="application-name" content="Focus App">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        /* Matrix Mint & Red Theme */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #050505; 
            color: #e5e5e5; 
            -webkit-font-smoothing: antialiased; 
            overscroll-behavior: none;
        }
        
        .glass-card { 
            background: rgba(20, 20, 20, 0.8); 
            backdrop-filter: blur(16px); 
            border: 1px solid rgba(74, 222, 128, 0.1); 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        }
        
        .timer-display { 
            font-family: 'JetBrains Mono', monospace;
            font-variant-numeric: tabular-nums; 
            letter-spacing: -0.05em; 
            color: #4ade80; 
            text-shadow: 0 0 20px rgba(74, 222, 128, 0.2); 
        }
        
        .dot { 
            width: 6px; height: 6px; border-radius: 50%; 
            background: #262626; transition: all 0.4s ease; 
        }
        .dot.active { 
            background: #4ade80; 
            box-shadow: 0 0 8px rgba(74, 222, 128, 0.5); 
        }
        
        .btn-transition { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="h-screen flex items-center justify-center overflow-hidden">

    <div class="w-full max-w-md px-6">
        <div class="glass-card rounded-[32px] p-12 text-center relative">
            
            <div id="session-dots" class="flex justify-center gap-2 mb-8">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>

            <div id="mode-label" class="text-[10px] uppercase tracking-[0.3em] text-neutral-500 mb-8 font-bold">Deep Work</div>
            
            <div id="timer" class="timer-display text-8xl font-medium mb-12">30:00</div>

            <div class="flex flex-col gap-4">
                <button id="toggle-btn" class="btn-transition w-full py-4 bg-[#4ade80] text-black rounded-xl font-bold hover:bg-[#22c55e] active:scale-[0.98] shadow-[0_0_15px_rgba(74,222,128,0.3)]">
                    Start
                </button>
                
                <div class="flex gap-3">
                    <button id="reset-btn" class="btn-transition flex-1 py-3 bg-neutral-900/50 text-rose-500 rounded-xl text-xs font-semibold border border-rose-900/30 hover:bg-rose-950/30 hover:border-rose-500/50 hover:text-rose-400">
                        Restart Clock
                    </button>
                    <button id="next-btn" class="btn-transition flex-1 py-3 bg-neutral-900/50 text-rose-500 rounded-xl text-xs font-semibold border border-rose-900/30 hover:bg-rose-950/30 hover:border-rose-500/50 hover:text-rose-400">
                        Next Phase
                    </button>
                </div>
                
                <div class="mt-8 pt-6 border-t border-white/5 relative">
                    <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 flex gap-2">
                        <button id="log-sheet-btn" class="bg-green-900/30 text-green-400 hover:text-green-300 hover:bg-green-900/50 text-[9px] px-3 py-1 rounded border border-green-800/50 transition-colors uppercase tracking-wider font-semibold">
                            Log to Sheet
                        </button>
                        <button id="reset-stats-btn" class="bg-red-900/30 text-red-400 hover:text-red-300 hover:bg-red-900/50 text-[9px] px-3 py-1 rounded border border-red-800/50 transition-colors uppercase tracking-wider font-semibold">
                            Clear Stats
                        </button>
                    </div>

                    <div class="flex justify-between text-[10px] uppercase tracking-widest text-neutral-600 mt-2 font-semibold">
                        <div class="text-left">
                            <p class="mb-1 text-green-700">Total Work</p>
                            <span id="total-work" class="text-green-400 text-sm font-mono">00:00:00</span>
                        </div>
                        <div class="text-right">
                            <p class="mb-1 text-red-800">Total Rest</p>
                            <span id="total-rest" class="text-red-500 text-sm font-mono">00:00:00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAaXrGGPPR5G1X8zNVBuvIhHLeBcXIkABA",
            authDomain: "pomodoro-fe692.firebaseapp.com",
            databaseURL: "https://pomodoro-fe692-default-rtdb.firebaseio.com/",
            projectId: "pomodoro-fe692",
            storageBucket: "pomodoro-fe692.firebasestorage.app",
            messagingSenderId: "578181442459",
            appId: "1:578181442459:web:71edaca2813b52ce5f8f3e",
            measurementId: "G-Z569M8NMMG"
        };
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxuoMLqdVcoDP9FEx239EzoME_XQq7mkfJ1rOqJEClCJbbP-XZXjAePJkIBHJgmfXhE/exec"; 
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const timerRef = ref(db, 'shared-timer');

        const MODES = { 
            WORK: { label: 'Deep Work', time: 30 * 60 }, 
            SHORT: { label: 'Short Break', time: 5 * 60 }, 
            LONG: { label: 'Long Break', time: 30 * 60 } 
        };

        let currentMode = 'WORK', timeLeft = MODES.WORK.time, timerId = null, alarmId = null, sessionCount = 0;
        let totalWorkSeconds = 0, totalRestSeconds = 0;
        let isAlarmActive = false; 
        
        // NEW: Absolute Target Time (The "True" End Time)
        let targetEndTime = null; 

        // UI
        const timerDisplay = document.getElementById('timer'), modeLabel = document.getElementById('mode-label');
        const toggleBtn = document.getElementById('toggle-btn'), resetBtn = document.getElementById('reset-btn'), nextBtn = document.getElementById('next-btn');
        const resetStatsBtn = document.getElementById('reset-stats-btn'), logSheetBtn = document.getElementById('log-sheet-btn');
        const dots = document.querySelectorAll('.dot'), workStat = document.getElementById('total-work'), restStat = document.getElementById('total-rest');

        // AUDIO ENGINE
        let audioCtx;
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playTone() {
            initAudio(); 
            const osc = audioCtx.createOscillator(); 
            const gain = audioCtx.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            gain.gain.setValueAtTime(0, audioCtx.currentTime); 
            gain.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.05); 
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.5);
            osc.connect(gain); gain.connect(audioCtx.destination); 
            osc.start(); osc.stop(audioCtx.currentTime + 1.5);
        }

        function startAlarm() {
            if (alarmId) return;
            toggleBtn.textContent = "Complete - Start Next";
            toggleBtn.classList.replace('bg-[#4ade80]', 'bg-orange-600'); 
            toggleBtn.classList.replace('text-black', 'text-white'); 
            toggleBtn.classList.add('animate-pulse');
            document.title = "⏰ TIME IS UP! — Focus App";
            playTone(); setTimeout(playTone, 800);
            alarmId = setInterval(() => { 
                playTone(); setTimeout(playTone, 800); 
                document.title = (document.title.startsWith("⏰")) ? "Focus App" : "⏰ TIME IS UP! — Focus App";
            }, 4000);
        }

        function stopAlarm() {
            if (alarmId) { clearInterval(alarmId); alarmId = null; }
            toggleBtn.classList.replace('bg-orange-600', 'bg-[#4ade80]'); 
            toggleBtn.classList.replace('text-white', 'text-black'); 
            toggleBtn.classList.remove('animate-pulse');
        }

        const format = (s) => new Date(s * 1000).toISOString().substr(11, 8);

        function updateDisplay() {
            const mins = Math.max(0, Math.floor(timeLeft / 60)).toString().padStart(2, '0');
            const secs = Math.max(0, (timeLeft % 60)).toString().padStart(2, '0');
            const timeString = `${mins}:${secs}`;
            timerDisplay.textContent = timeString;
            if (!alarmId) document.title = `${timeString} — Focus App`;

            modeLabel.textContent = MODES[currentMode].label;
            dots.forEach((dot, i) => dot.classList.toggle('active', i < sessionCount));
            workStat.textContent = format(totalWorkSeconds);
            restStat.textContent = format(totalRestSeconds);
        }

        function syncToCloud() {
            // We now sync 'targetEndTime' which is the source of truth
            set(timerRef, { 
                currentMode, timeLeft, sessionCount, totalWorkSeconds, totalRestSeconds, 
                isAlarmActive, targetEndTime 
            });
        }

        function handleCycleEnd() {
            clearInterval(timerId); timerId = null;
            if (currentMode === 'WORK') { sessionCount++; currentMode = (sessionCount >= 4) ? 'LONG' : 'SHORT'; } 
            else { if (currentMode === 'LONG') sessionCount = 0; currentMode = 'WORK'; }
            
            timeLeft = MODES[currentMode].time;
            targetEndTime = null; // Reset target on cycle end
            isAlarmActive = true; 
            
            updateDisplay(); 
            syncToCloud();
        }

        toggleBtn.addEventListener('click', () => {
            initAudio(); 
            
            if (isAlarmActive) { 
                isAlarmActive = false; stopAlarm(); toggleBtn.click(); syncToCloud(); return; 
            }

            if (timerId) { 
                // PAUSE
                clearInterval(timerId); timerId = null; 
                targetEndTime = null; // Clear the target time
                toggleBtn.textContent = 'Resume'; 
                syncToCloud(); 
            } else {
                // START / RESUME
                toggleBtn.textContent = 'Pause';
                
                // 1. Set the Absolute End Time (Now + Remaining Seconds)
                // This timestamp is what other devices will see
                targetEndTime = Date.now() + (timeLeft * 1000);
                
                // 2. Sync immediately so Mac/Chromebook sees the new End Date
                syncToCloud(); 

                timerId = setInterval(() => {
                    const now = Date.now();
                    
                    // 3. Always calculate remaining time based on the Fixed Target
                    // This fixes the sleep/drift issue
                    const exactTimeLeft = Math.ceil((targetEndTime - now) / 1000);
                    
                    // Calculate stats
                    const delta = timeLeft - exactTimeLeft;
                    if (delta > 0) {
                        if (currentMode === 'WORK') totalWorkSeconds += delta; 
                        else totalRestSeconds += delta;
                    }

                    timeLeft = exactTimeLeft;

                    if (timeLeft <= 0) {
                        handleCycleEnd();
                    } else {
                        updateDisplay();
                        if (timeLeft % 5 === 0) syncToCloud();
                    }
                }, 1000);
            }
        });

        resetBtn.addEventListener('click', () => { 
            isAlarmActive = false; stopAlarm(); clearInterval(timerId); timerId = null; 
            targetEndTime = null; 
            timeLeft = MODES[currentMode].time; 
            toggleBtn.textContent = 'Start'; updateDisplay(); syncToCloud(); 
        });

        nextBtn.addEventListener('click', () => { 
            isAlarmActive = false; stopAlarm(); handleCycleEnd(); isAlarmActive = false; 
            toggleBtn.textContent = 'Start'; updateDisplay(); syncToCloud(); 
        });

        resetStatsBtn.addEventListener('click', () => {
            if(confirm("Are you sure you want to clear your stats?")) { totalWorkSeconds = 0; totalRestSeconds = 0; updateDisplay(); syncToCloud(); }
        });

        logSheetBtn.addEventListener('click', () => {
            logSheetBtn.textContent = "Saving...";
            const url = `${GOOGLE_SCRIPT_URL}?work=${format(totalWorkSeconds)}&rest=${format(totalRestSeconds)}`;
            fetch(url, { mode: 'no-cors' }).then(() => { logSheetBtn.textContent = "Saved!"; setTimeout(() => logSheetBtn.textContent = "Log to Sheet", 2000); });
        });

        onValue(timerRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                if (!timerId) {
                    currentMode = data.currentMode; 
                    sessionCount = data.sessionCount;
                    totalWorkSeconds = data.totalWorkSeconds; 
                    totalRestSeconds = data.totalRestSeconds;

                    // THE FIX: Sync based on Absolute Timestamp
                    if (data.targetEndTime) {
                        // If there is a target time in the cloud, calculate the REAL time left
                        const now = Date.now();
                        const realTimeLeft = Math.ceil((data.targetEndTime - now) / 1000);
                        timeLeft = (realTimeLeft > 0) ? realTimeLeft : 0;
                        targetEndTime = data.targetEndTime; // Keep local target in sync
                    } else {
                        // If paused, just use the saved duration
                        timeLeft = data.timeLeft;
                        targetEndTime = null;
                    }
                }
                
                isAlarmActive = data.isAlarmActive;
                if (isAlarmActive) startAlarm(); else stopAlarm();

                updateDisplay();
            }
        });
        updateDisplay();
    </script>
</body>
</html>
